---
title: "Homework 4 Submission"
author: "Yahriel Salinas-Reyes"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
rm(list = ls(all=TRUE))
graphics.off()
shell("cls")
knitr::opts_chunk$set(echo = TRUE)
```



```{r, include=FALSE}
library(readxl)
library(here)
library(epiR)
library(MASS)
library(nnet)
library(car)
library(PairedData)
library(tidyverse)
library(ggplot2)
library(pwr)
library(FSA)
library(ggpubr)
library(rstatix)
library(datarium)
library(emmeans)
library(sjstats)
library(lme4)
library(lmerTest)
library(MuMIn)
library(forcats)

library(readxl)  
library(tidyverse)  
library(dplyr)  
library(ggplot2)  
library(pwr)  
library(ggpubr)  
library(rstatix)  
library(datarium)  
library(emmeans)  
library(sjstats)  
library(lme4)  
library(lmerTest)  
library(MuMIn)  
library(dplyr)  
library(forcats)  

## Import Data Sets
alcohol <- read_excel("alcohol.xls")
ischemic <- read_excel("ischemic.xls")
lowbwt <- read_excel("lowbwt.xls")
water <- read_excel("water.xls")
actions <- read_excel("actions.xls")
hospital <- read_excel("hospital.xls")
heart <- read_excel("heart.xls")
detroit <- read_excel("detroit.xls")
stenosis <- read_excel("stenosis.xls")
dialysis <- read_excel("dialysis.xls")
cyto <- read_excel("cyto.xls")
bladder <- read_excel("bladder.xls")
```

# Question 1
a. Evaluate the null hypothesis that the population proportions of students who drove while drinking are the same in the two calendar years (2010 and 2014).

> For this analysis, we can use the Chi-square test to compare the proportions of students who drove while drinking in both years.

```{r, out.width="60%",}
# Create the contingency table
data1 <- matrix(c(1250, 991, 1387, 1666), nrow = 2, byrow = TRUE)
colnames(data1) <- c("2010", "2014")
rownames(data1) <- c("Yes", "No")
data1 <- as.table(data1)

# Perform the Chi-square test
chi_square_test <- chisq.test(data1)

# Print the result
print(chi_square_test)

```
b. What do you conclude about the behavior of college students?

> Since the p-value (1.241e-13) from the Chi-squared rest is less than the significance level, we reject the null hypothesis, indicating that there is a significant difference in the proportions of students who drove while drinking between the two years.

# Question 2
a. Do these data support the null hypothesis that there is no association between the time of screening and diagnosis?

> Here, we can also use the Chi-square test to assess the association between the first and second screenings.

```{r, out.width="60%",}
# Create the contingency table
data2 <- matrix(c(1763, 489, 403, 670), nrow = 2, byrow = TRUE)
colnames(data2) <- c("Present", "Absent")
rownames(data2) <- c("Present", "Absent")
data2 <- as.table(data2)

# Perform the Chi-square test
chi_square_test2 <- chisq.test(data2)

# Print the result
print(chi_square_test2)

```

> Since the p-value (< 2.2e-16) from the Chi-squared rest is less than the significance level, we reject the null hypothesis, indicating that there is a significant difference or association between the time of screening and diagnosis.

b. The data could also be displayed in a different manner. Is there anything wrong with this presentation? Why?

> The alternative presentation aggregates the results, which could obscure variability in the data. This format might hide differences in screening consistency between the two tests, making it challenging to assess intra-observer reliability accurately.

# Question 3
a. Test the null hypothesis that there is no association between drinking status on the two different types of questionnaires.

> Since we want to compare two categorical variables (drinking status from two different questionnaires), a Chi-square test is appropriate.

```{r, out.width="60%",}
# Load the necessary library
library(readxl)

# Import the dataset
alcohol_data <- read_excel("alcohol.xls")

# Create a contingency table
contingency_table <- table(alcohol_data$genques, alcohol_data$alcques)

# Perform the Chi-square test
chi_square_result <- chisq.test(contingency_table)

# Display the result
print(chi_square_result)

```
b. What do you conclude?

> Based on the p-value from the Chi-square test result which is less than 0.05, we reject the null hypothesis and we can conclude there is a significant association between the two questionnaires.

# Question 4
a. Create a two-way scatter plot for these data.
```{r, out.width="60%",}
# Load the necessary library
library(readxl)
library(ggplot2)

# Import the dataset
ischemic_data <- read_excel("ischemic.xls")

# Create a scatter plot
ggplot(ischemic_data, aes(x = time, y = duration)) +
  geom_point() +
  labs(title = "Scatter Plot of Time to Angina vs Duration of Angina",
       x = "Time to Angina (seconds)",
       y = "Duration of Angina (seconds)")
```
b. In the population of patients with ischemic heart disease, does there appear to be any evidence of a linear relationship between time to angina and the duration of the attack?

> We can inspect the scatter plot for a linear trend. Since the points suggest a linear relationship, we can proceed with correlation analysis.

c. In calculating the correlation coefficient, which test will you use, Pearson or Spearman? Why?

> Since both variables are continuous and likely normally distributed, use Pearson's correlation. If not normally distributed, use Spearman.

d. Test the null hypothesis that the population correlation is equal to 0.

```{r, out.width="60%",}
# Perform hypothesis test for correlation
cor_test_result <- cor.test(ischemic_data$time, ischemic_data$duration)

# Print results
cor_test_result
```
> Since the p-value here is greater than 0.05, then we fail to reject the null and conclude that there is no significant correlation, correlation = 0. 

# Question 5

> Use Spearman's rank correlation because the Apgar score is ordinal.

```{r, out.width="60%",}
# Import dataset
lowbwt <- read_excel("lowbwt.xls")



# Conduct Spearman correlation
spearman_result <- cor.test(lowbwt$sbp, lowbwt$apgar5, method="spearman")

# Print results
spearman_result

```
b. Null hypothesis and conclusion?

> We fail to reject the null hypothesis that there is no correlation between systolic blood pressure and Apgar score, since the p-value is greater than 0.05.

# Question 6
a. Construct a scatter plot for these data.
b. Calculate correlation.
c. Is this correlation significantly different from 0?
```{r, out.width="60%",}
# Import dataset
water <- read_excel("water.xls")

# Create scatter plot
plot(water$fluoride, water$caries,
     main="Scatter Plot of Fluoride vs Dental Caries",
     xlab="Fluoride Content (ppm)",
     ylab="Number of Caries per 100 Children",
     pch=19, col='green')

## B. 
# Calculate correlation
fluoride_caries_correlation <- cor(water$fluoride, water$caries)
fluoride_caries_correlation

## C. 
# Conduct hypothesis test
correlation_test <- cor.test(water$fluoride, water$caries)

# Print results
correlation_test

```

> Since the p-value is than 0.05, we conclude that the correlation is significantly different from 0.

# Question 7
a. Calculate correlations between ranks.
b. Is each correlation significantly different from 0?

```{r, out.width="60%",}
# Import dataset
actions <- read_excel("actions.xls")

# Calculate correlations
correlation_1991_1992 <- cor(actions$rank91, actions$rank92)
correlation_1991_1993 <- cor(actions$rank91, actions$rank93)
correlation_1991_1994 <- cor(actions$rank91, actions$rank94)
correlation_1991_1995 <- cor(actions$rank91, actions$rank95)

# Print results
correlation_1991_1992
correlation_1991_1993
correlation_1991_1994
correlation_1991_1995
## The Correlation decreases with the increasing year. 

## B. 
# Conduct hypothesis tests
test_1991_1992 <- cor.test(actions$rank91, actions$rank92)
test_1991_1993 <- cor.test(actions$rank91, actions$rank93)
test_1991_1994 <- cor.test(actions$rank91, actions$rank94)
test_1991_1995 <- cor.test(actions$rank91, actions$rank95)

# Print results
test_1991_1992
test_1991_1993
test_1991_1994
test_1991_1995
 
## Yes, they all are significanctly different from zero.
```
c. Are states equally strict?

> Since the correlations are low as years increase, it may indicate inconsistency among states.

# Question 8

```{r, out.width="60%",}

# Import dataset
library(readxl)
lowbwt <- read_excel("lowbwt.xls")


# a. Compute least-squares regression line
lm_sbp_gestage <- lm(sbp ~ gestage, data = lowbwt)
summary(lm_sbp_gestage)

# Interpretation: The estimated slope (b1) represents the change in systolic blood pressure for each week increase in gestational age.

# b. Hypothesis Test for Slope
summary(lm_sbp_gestage)$coefficients

# Interpretation: Since the P-value for b1 is less than 0.05, we conclude that b1 differs significantly from zero.

# c. Predicted systolic blood pressure at gestational age of 31 weeks
predict(lm_sbp_gestage, newdata = data.frame(gestage = 31))

```

# Question 9


```{r, out.width="60%",}
# Load dataset
miner <- data.frame(year=1:12, rate=c(2.419, 1.732, 1.361, 1.108, 0.996, 0.952, 0.904, 0.792, 0.701, 0.890, 0.799, 1.084))

# a) Scatter plot
plot(miner$year, miner$rate, main="Fatality Rate vs Year", xlab="Year", ylab="Fatality Rate")

# b) Least-squares regression line
model_9b <- lm(rate ~ year, data=miner)
summary(model_9b)

# c) Transformation with ln(x)
miner$log_year <- log(miner$year)
model_9c <- lm(rate ~ log_year, data=miner)
summary(model_9c)

# d) Transformation with 1/x
miner$inv_year <- 1 / miner$year
model_9d <- lm(rate ~ inv_year, data=miner)
summary(model_9d)

# e) Choose best model based on R-squared and p-value comparisons
## Based on the R^2 value and p-values, the first model had the moderate R^2 with the at least half of the variance explained and the p-value just above the significance interval suggesting near statistical significance.

# f) Use best model to predict rate for year 9
predict(model_9b, newdata=data.frame(year=9)) # Replace model if another is best
```

# Question 10

```{r, out.width="60%",}
# a) Numerical summaries
summary(hospital$expadm)
summary(hospital$los)

# b) Histograms
hist(hospital$expadm, main = "Histogram of Expense per Admission", xlab = "Expense per Admission")
hist(hospital$los, main = "Histogram of Length of Stay", xlab = "Length of Stay")

# c) Least-squares regression line
model_exp_los <- lm(expadm ~ los, data = hospital)
summary(model_exp_los)

# d) Interpretation of the slope
# This describes the change in expense per admission with each additional day in length of stay. While the p-value for the b1 is less than .05, we can conclude that b1 differs significancly from zero.

# e) Diagnostic plots (4 plots)
par(mfrow=c(2,2))
plot(model_exp_los)

```

# Question 11
```{r, out.width="60%",}
# Load dataset
lowbwt <- read_excel("lowbwt.xls")

shapiro.test(lowbwt$sbp)
shapiro.test(lowbwt$gestage)

lr <- lm(lowbwt$sbp~lowbwt$apgar5+lowbwt$gestage)
summary(lr)

new <- data.frame(31,7)
colnames(new) <- c('gestage','apgar5')
new
head(predict(lr,newdata=new),n=1)

y <- 9.8 + 0.4875*7+1.1848*31 
y

plot(lr) 
```

# Question 12
```{r, out.width="60%",}
# (a) Construct model with gestage, apgar5, and sex as predictors
model_12a <- lm(sbp ~ gestage + apgar5 + sex, data = lowbwt)
summary(model_12a)

# (b) Adding interaction between gestage and sex
model_12b <- lm(sbp ~ gestage * sex + apgar5, data = lowbwt)
summary(model_12b)

# Based on the P-values which for both models are below .05, they both have statistical significance. The first one has a lower score. But looking at the interaction term in the 2nd model, it's p-value is quite high suggesting that the interaction doesn't have statistical significance. 
```
# Question 13
```{r, out.width="60%",}
# Load necessary library and dataset
library(readxl)
heart <- read_excel("heart.xls")

# Part a: Fit two simple linear regression models for PDI and MDI
model_13_pdi <- lm(pdi ~ trtment, data = heart)
model_13_mdi <- lm(mdi ~ trtment, data = heart)

# Display the summaries to interpret the results
summary_pdi <- summary(model_13_pdi)
summary_mdi <- summary(model_13_mdi)

# Print summary outputs
print(summary_pdi)
print(summary_mdi)

# Part b: Interpretation for PDI
# Who is more likely to have a higher PDI score?
cat("\nInterpretation for PDI:\n")
cat("A child assigned to the low-flow bypass group is more likely to have a higher PDI score by", 
      round(summary_pdi$coefficients["trtment", "Estimate"], 2), "points on average compared to a child in the circulatory arrest group.\n")


# Part c: Check for statistical significance at the 0.05 level
cat("\nStatistical significance for PDI:\n")
cat("The treatment group difference in PDI scores is statistically significant (p-value =", 
      round(summary_pdi$coefficients["trtment", "Pr(>|t|)"], 4), ").\n")


cat("\nInterpretation for MDI:\n")
cat("A child assigned to the low-flow bypass group is more likely to have a higher MDI score by", 
      round(summary_mdi$coefficients["trtment", "Estimate"], 2), "points on average compared to a child in the circulatory arrest group.\n")

  
cat("\nStatistical significance for MDI:\n")
cat("The treatment group difference in MDI scores is not statistically significant.\n")


```

# Question 14
```{r, out.width="60%",}
ggplot(hospital) + geom_point(aes(x=expadm,y=salary)) + 
  ggtitle('Salary vs Expense') + ylab('Salary in USD') + 
  xlab('Expenses in USD')

lr1 <- lm(expadm~salary,data=hospital)
summary(lr1)

lr2 <- lm(expadm~los,data=hospital)
summary(lr2)

lr3 <- lm(expadm~los+salary+los*salary,data=hospital)
summary(lr3)


anova(lr1, lr2, lr3)

AIC(lr1, lr2, lr3)
```

# Question 15
```{r, out.width="60%",}
# Load necessary library and dataset
detroit <- read_excel("detroit.xls")


lr <- lm(homicide~register+weekly+unemp+police,data=detroit)
summary(lr)

vif(lr)

lr1 <- lm(homicide~register+weekly+unemp,data=detroit)
vif(lr1)
summary(lr1)


lr2 <- lm(homicide~register+police+unemp,data=detroit)
vif(lr2)
summary(lr2)

lr3 <- lm(homicide~register,data=detroit)
anova(lr,lr1,lr2,lr3)

AIC(lr, lr1, lr2, lr3)

summary(lr3)

```

# Question 16
```{r, out.width="60%",}

# a. Logistic regression for hemorrhage
glm_hemorrhage <- glm(grmhem ~ apgar5 + tox, family = binomial, data = lowbwt)
summary(glm_hemorrhage)

# b. Predicted probability for apgar5 = 3 and tox = 1
predict(glm_hemorrhage, newdata = data.frame(apgar5 = 3, tox = 1), type = "response")

# c. Hypothesis test for b1
# Based on the model summary, we see b1 (agpar5) has a p-value below the significance level suggesting that the b1 differs significantly from zero. We reject the null hypothesis. 

```

# Question 17
```{r, out.width="60%",}
# Load dataset
stenosis <- read_excel("stenosis.xls")

# a) Logistic regression model for aortic stenosis with smoking and gender
model_17a <- glm(disease ~ smoke + sex, family="binomial", data=stenosis)
summary(model_17a)

# Interpretation of odds
exp(coef(model_17a)[2]) # Odds ratio for smokers vs nonsmokers

# b) Discuss interaction effects
# Based on the model summary, I believe that the presence of aortic stenosis differs between males and females. The coefficient b2 for sex is below 0.05 suggesting statistical significance.

```

# Question 18
```{r, out.width="60%",}
# Load dataset
dialysis <- read_excel("dialysis.xls")
View(dialysis)

# a) Logistic regression for age, sex, and race effects on peritonitis
model_18a_age <- glm(perito ~ age, family="binomial", data=dialysis)
model_18a_sex <- glm(perito ~ sex, family="binomial", data=dialysis)
model_18a_race <- glm(perito ~ race, family="binomial", data=dialysis)
summary(model_18a_age)
summary(model_18a_sex)
summary(model_18a_race)

# b) Prediction for white male, age 50
predict(model_18a_age, newdata=data.frame(age=50, sex=0, race=0), type="response")

# c) Response Variable Categorization
# Yes I do see a problem specifically with how age is categorized in comparison to the other variables. While the other variables are in binomial form (binary), the presence of a ordinal set of data is mixed with the bigger data meaning that it can obscure our model and some of our interpretations since it is not consistent.

```

# Question 19
```{r, out.width="60%",}
# Load dataset
cyto <- read_excel("cyto.xls")
view(cyto)

# Part A:
km.cyto <- survfit(Surv(time[group==1], censor[group==1]) ~ 1, type = "kaplan-meier", data = cyto)
km.cyto # median censor time is 170 months
summary(km.cyto)

plot(km.cyto,conf.int=T, xlab="Time (months)", ylab=" % cessation = S(t)", col=c("red"),
     main="KM-Model", las=1, lwd=2, mark.time=T)


km.cyto2 <- survfit(Surv(time[group==2], censor[group==2]) ~ 1, type = "kaplan-meier", data = cyto)
km.cyto2 # median censor time is 47 months

plot(km.cyto2,conf.int=T, xlab="Time (months)", ylab=" % cessation = S(t)", col=c("red"),
     main="KM-Model", las=1, lwd=2, mark.time=T)

survdiff(Surv(time, censor)~ group, data=cyto)

```
# Question 20
```{r, out.width="60%",}

# Survival Curves
km.bl <- survfit(Surv(time[group==1], censor[group==1]) ~ 1, type = "kaplan-meier", data = bladder)
km.bl # median censor time is 16 months

summary(km.bl)

plot(km.bl,conf.int=T, xlab="Time (months)", ylab=" % cessation = S(t)", col=c("red"),
     main="KM-Model", las=1, lwd=2, mark.time=T)

km.b2 <- survfit(Surv(time[group==2], censor[group==2]) ~ 1, type = "kaplan-meier", data = bladder)
km.b2 # median censor time is 26 months
summary(km.b2)


plot(km.b2,conf.int=T, xlab="Time (months)", ylab=" % cessation = S(t)", col=c("red"),
     main="KM-Model", las=1, lwd=2, mark.time=T)


survdiff(Surv(time, censor)~ group, data=bladder)

```





















